<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Refund Tax Record Query</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg1:#89f7fe; --bg2:#66a6ff;
      --card:#fff; --text:#111827; --muted:#6b7280;
      --line:#e5e7eb; --primary:#667eea;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:linear-gradient(120deg,var(--bg1),var(--bg2));
      display:flex; align-items:flex-start; justify-content:center;
      min-height:100vh;
    }
    .wrap{width:min(960px,94vw); margin:7vh auto; padding:0 12px;}
    .card{background:var(--card); color:var(--text); border-radius:18px; padding:22px;
      box-shadow:0 18px 40px rgba(0,0,0,.18); animation:fadeIn .45s ease both;}
    .title{margin:0 0 10px; font-weight:800; font-size:22px}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    label{font-weight:700}
    input{
      padding:12px 14px; border:1px solid var(--line); border-radius:12px; outline:none; transition:.15s;
    }
    input:focus{border-color:#93c5fd; box-shadow:0 0 0 4px #93c5fd33}
    .btn{
      padding:12px 16px; border:0; border-radius:12px; color:#fff; background:linear-gradient(90deg,#667eea,#764ba2);
      font-weight:800; cursor:pointer; transition:.18s transform,.18s box-shadow;
    }
    .btn:hover{transform:translateY(-1px); box-shadow:0 8px 18px rgba(102,126,234,.35)}
    table{width:100%; border-collapse:separate; border-spacing:0; margin-top:16px; background:#fff; border-radius:14px; overflow:hidden}
    thead th{background:#6366f1; color:#fff; padding:12px; text-align:center}
    tbody td{padding:12px; border-top:1px solid #eef2f7; text-align:center}
    .note{color:var(--muted); margin-top:8px}
    @keyframes fadeIn{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:translateY(0)}}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h2 class="title">Refund Tax Record Query</h2>

    <div class="row" style="margin-bottom:12px">
      <label for="year">Year</label>
      <input type="text" id="year" placeholder="Enter year" required style="min-width:140px">
      <button class="btn" onclick="queryRefundRecords()">Query Records</button>
    </div>

    <div class="note">Tip: default is last year.</div>

    <table id="resultTable" style="display:none;">
      <thead>
      <tr>
        <th>ID</th>
        <th>Refund Amount</th>
        <th>Refund Date</th>
        <th>Username</th>
      </tr>
      </thead>
      <tbody id="resultBody"></tbody>
    </table>
  </div>
</div>

<script>
  const lastYear = new Date().getFullYear() - 1;
  document.getElementById("year").value = lastYear;

  function getUsername() {
    const params = new URLSearchParams(window.location.search);
    const usernameFromQuery = params.get('username');
    return (usernameFromQuery && usernameFromQuery.trim())
            || sessionStorage.getItem('username')
            || localStorage.getItem('username')
            || '';
  }

  function ensureToken() {
    const p = new URLSearchParams(location.search);
    const tFromUrl = p.get('token');
    if (tFromUrl) {
      localStorage.setItem('token', tFromUrl);
      sessionStorage.setItem('token', tFromUrl);
    }
    return localStorage.getItem('token') || sessionStorage.getItem('token') || '';
  }

  const username = getUsername();
  const token = ensureToken();

  async function queryRefundRecords() {
    const year = document.getElementById("year").value;
    if (!year) {
      alert("Please enter a year!");
      return;
    }

    try {
      const token = localStorage.getItem("token");
      const response = await fetch("/record/refundTexRecordQuery?username=" + username + "&year=" + year, {
        method: "GET",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        }
      });

      if (!response.ok) {
        throw new Error("Query failed with status " + response.status);
      }

      const records = await response.json();
      renderTable(records);

    } catch (error) {
      console.error("Error querying refund records:", error);
      alert("Failed to query refund records!");
    }
  }

  function renderTable(records) {
    const resultTable = document.getElementById("resultTable");
    const resultBody = document.getElementById("resultBody");
    resultBody.innerHTML = "";

    if (!records || records.length === 0) {
      alert("No refund records found for this year.");
      resultTable.style.display = "none";
      return;
    }

    records.forEach(record => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${record.id}</td>
        <td>${record.refundTaxAmount}</td>
        <td>${record.refundDate}</td>
        <td>${record.username}</td>
      `;
      resultBody.appendChild(row);
    });

    resultTable.style.display = "table";
  }


</script>
</body>
</html>
